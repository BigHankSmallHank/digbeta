\documentclass{sig-alternate-05-2015}

\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}

\begin{document}

%\setcopyright{}
%\doi{}
%\isbn{}
%\conferenceinfo{}
%\acmPrice{\$15.00}
% Author Metadata

\title{Trajectory Recommendation}

%\numberofauthors{}
%\author{
%\alignauthor
%\alignauthor
%\alignauthor
%}

\maketitle

%\begin{abstract}
%\end{abstract}

% The code below should be generated by the tool at
% http://dl.acm.org/ccs.cfm
% Please copy and paste the code instead of the example below. 

%\printccsdesc
%\keywords{}

\section{Proposed Method}


\subsection{Problem Formulation}
\label{sec:formulation}
For a set of Point/Place of Interest (POI) $\mathcal{P}$ and a set of users $\mathcal{U}$,
a trajectory $\mathcal{T}_u$ of user $u$ is an ordered sequence of POIs,
i.e.,
\begin{displaymath}
    \mathcal{T}_u = ((p_1, t_{p_1}^s, t_{p_{1}}^e), \dots, (p_L, t_{p_L}^s, t_{p_L}^e)), 
    u \in \mathcal{U}, 
    p_j \in \mathcal{P}, 1 \le j \le L
\end{displaymath}
where $t_p^s$ and $t_p^e$ is the start and end time of user $u$ at POI $p$ respectively.

Given a set of trajectories $\{ \mathcal{T}_u^i \}, u \in \mathcal{U}$ with visited POIs in $\mathcal{P}$, 
a start POI $p_s$, a destination $p_e$ and an integer $2 < L \le |\mathcal{P}|$,
trajectory recommendation is to recommend the \textit{most likely} trajectory $(p_s, \dots, p_e)$ to user $u$ such that
the number of visited POIs is $L$.


\subsection{Ranking of POIs}
% ranking of POIs focus on modeling the (personalised) preference of POIs
We first produce a ranking of POIs, i.e., $<_{p_i, p_j} \subset \mathcal{P}^2$,
with respect to constraints $(p_s, p_e, L)$ 
using rankSVM with linear kernel and $L2$ loss\cite{lranksvm}, 
i.e.,
\begin{displaymath}
\min_{\mathbf{w}} \frac{1}{2} \mathbf{w}^T \mathbf{w} +
                  C \sum_{(i, j) \in P} \max \left( 0, 1 - \mathbf{w}^T (\mathbf{x}_i - \mathbf{x}_j) \right)^2
\end{displaymath}
where $\mathbf{w}$ is a vector of parameters, 
$C > 0$ is the regularization parameter and 
$\mathbf{x}_i$ is the feature vector of POI $p_i$.
Features used for ranking POIs are:
\begin{itemize}
\item Popularity of a POI, which is defined as the number of distinct users that visited the POI\cite{ht10}.
\item The total number of visits of a POI,
      \begin{displaymath}
          N(p) = \sum_{u \in \mathcal{U}} \sum_i \sum_{p_j \in \mathcal{T}_u^i} \delta(p_j = p)
      \end{displaymath}
\item Average visit duration of POI\cite{ijcai15},
      \begin{displaymath}
          \bar{V}(p) = \frac{1}{N(p)} \sum_{u \in \mathcal{U}} \sum_i \sum_{p_j \in \mathcal{T}_u^i} (t_{p_j}^s - t_{p_j}^e) \delta(p_j = p),
          p \in \mathcal{P}
      \end{displaymath}
\item Whether the category (e.g., structures, entertainment and shopping etc.) is the same as that of $p_s$ (and $p_e$).
\item Distance from POI $p$ to $p_s$ (and $p_e$) using haversine formula \cite{wiki_haversine},
      \begin{displaymath}
      d = 2 R_1 \arcsin \sqrt{ \sin^2 \left( \frac{\Delta \phi}{2} \right) + 
           \cos \phi_p \cos \phi_{p_s} \sin^2 \left( \frac{\Delta \lambda}{2} \right) }
      \end{displaymath}
            where $R_1 = 6371.0088$ km is the mean earth radius \cite{wiki_earth_radius}, 
            $\Delta \phi = \phi_p - \phi_{p_s}$, $\Delta \lambda = \lambda_p - \lambda_{p_s}$,
            and $\phi_p$, $\lambda_p$ are the latitude and longitude of POI $p$ respectively.
\item The difference in popularity of POI $p$ from $p_s$ (and $p_e$),
      i.e., $\Delta Pop = Pop(p) - Pop(p_s)$.
\item The difference in average visit duration of POI $p$ from that of $p_s$ (and $p_e$),
      i.e., $\Delta \bar{V} = \bar{V}(p) - \bar{V}(p_s)$
\item The number of POIs in the expected trajectory, i.e. $L$
\end{itemize}

To generate the target/label of a POI in training set,
we first group trajectories with the same start POI $p_s'$, end POI $p_e'$ and the number of visited POIs $L'$ together,
each group of trajectories form a query,
and the target/label of POI $p$ in a particular query (i.e., trajectory group) are the number of occurrence
in trajectories of that query, 
without counting the occurrence of $p$ as start or end POI of a trajectory.

The ranking scores of POIs are transformed to probabilities using Platt scaling\cite{platt99} by
\begin{displaymath}
    %P(y=1 |p) = \frac{1}{1 + e^{A f(x) + B}, p \in P
    P_R(p |(p_s, p_e, L)) = \frac{1}{1 + e^{\alpha R(p) + \beta}}, p \in \mathcal{P}
\end{displaymath}
where $R(p)$ is the ranking score of POI $p$, $\alpha$ and $\beta$ are parameters learned from training set\cite{plattnote07}.


\subsection{Factorising Transition Probabilities between POIs}
To deal with data sparsity,
the transition probability between a pair of POIs $(p_i, p_j)$ was factorised into the product of
transition probabilities between the following individual features of that POI pair.
\begin{enumerate}
\item The category of POI, $P(Cat(p_j) | Cat(p_i))$
      is the transition probability from the category of $p_i$ to the category of $p_j$.
\item The popularity of POI, which was first discritized with uniform intervals in log-scale,
      and $P(Pop(p_j) | Pop(p_i))$ is the transition probability from the interval with $Pop(p_i)$ 
      to the interval with $Pop(p_j)$.
\item The total number of visits of POI, similarly, it was first discritized with uniform intervals in log-scale,
      and $P(N(p_j) | N(p_i))$ is the transition probability from the interval with $N(p_i)$ 
      to the interval with $N(p_j)$.
\item The average visit duration of POI, and again, it was first discritized with uniform intervals in log-scale,
      and $P(\bar{V}(p_j) | \bar{V}(p_i))$ is the transition probability from the interval with $\bar{V}(p_i)$ 
      to the interval with $\bar{V}(p_j)$.
\item The neighborhood relationship between $p_i$ and $p_j$,
      which was represented by the geographical clusters of POIs that $p_i$ and $p_j$ reside in,
      and $P(Neighb(p_i, p_j)) = P(c_{p_j} | c_{p_i})$ is the transition probability from the cluster with 
      $p_i$ (i.e., $c_{p_i}$) to the cluster with $p_j$ (i.e., $c_{p_j}$).
\end{enumerate}

Assuming independence between these features,
the transition probability between $p_i$ and $p_j$ can be factorised as follows,
\begin{align*}
    & P(p_j | p_i) \\
   =& \frac{1}{Z_i} P(Cat(p_j) | Cat(p_i)) \times P(Pop(p_j) | Pop(p_i)) \times \\
    & P(N(p_j) | N(p_i)) \times P(\bar{V}(p_j) | \bar{V}(p_i)) \times P(Neighb(p_i, p_j)) \\
    & i \ne j, p_i, p_j \in \mathcal{P}
\end{align*}
where $Z_i$ is a normalising constant.

%POIs are grouped into several clusters according to their geographical coordinates using K-means
%to reflect their neighborhood relationships.

% Kronecker product
We compute the transition probabilities of the above individual POI features 
using maximum likelihood estimation, 
i.e., counting the number of transitions for each pair of features then normalising each row,
taking care of zeros by adding a small number $\epsilon$
\footnote{In our experiments, $\epsilon$ for a specific row in the transition matrix equals $0.2$ times 
the minimum non-zero value in that row.}
to each number,
which results a transition matrix for each of the above POI features.

By computing the Kronecker product of transition matricies of all the POI features,
we get a (unnormalised) transition matrix of POI features.
However, to obtain the transition probabilities between each POI pair $(p_i, p_j), i \ne j$,
there are two cases needs to be dealt with:
\begin{enumerate}
\item POI features which represent POIs that do not exist in $\mathcal{P}$,
\item POI features that corresponds to more than one POIs in $\mathcal{P}$.
\end{enumerate}

% deal with feature vector without corresponding POI or with more than one POIs.
For the first case, 
the corresponding rows and columns in the result matrix of Kronecker product are simply removed.

The second case was a bit subtle.
POIs with exactly the same features are treated as a POI group,
the incoming transition probability of the group was divided uniformly among POIs in the same group,
which corresponds to choose a POI in the group uniformly at random;
the outgoing transition probability of each POI is set the same as the outgoing transition probability of the POI group,
as one had already been in the POI group in this case;
the self-loop of the POI group represents the transitions between POIs in the group,
suppose the transition probability from a POI group to itself is $P_o$,
for each POI $p_i$ in the group, the transition probability from $p_i$ to any other POI $p_j$ in the same group
is $\frac{P_o}{M-1}$, where $M$ is the number of POIs in the group.
\footnote{Self-loop of individual POIs are forbidden here, so $P(p_i | p_i) = 0$ for all $p_i \in \mathcal{P}$.}

Finally, we normalise each row of the transition matrix of POIs to get transition probabilities for each pair of POIs.
\footnote{Note that dealing with the second case before or after row normalisation leads to the same transition probabilities, 
as the process does not change the normalising constant of each row of the transition matrix.}


\subsection{Recommend Trajectories}
%\subsection{Probabilistic Model incorporating both ranking and transition}
% ranking of POIs focus on modeling the (population) preference of POIs
% MC focus on modeling the transition patterns between POIs
% we can capture both aspects by combining them

To recommend the \textit{most likely} trajectory with respect to constraints $(p_s, p_e, L)$,
we want to maximize the ranking probabilities of POIs in the trajectory as well as
the likelihood of the trajectory w.r.t. the Markov Chain corresponds to the transition matrix of POIs.
Specifically, we want to maximize both of the following two quantities.
\begin{itemize}
\item The ranking probabilities of POIs in trajectory $(p_{j_1}, \dots, p_{j_L})$:
      \begin{displaymath}
          \ell_R((p_{j_1}, \dots, p_{j_L})) = \sum_{k=1}^L \log \left( P_R(p_{j_k} |(p_s, p_e, L)) \right)
      \end{displaymath}
\item The log likelihood of trajectory $(p_{j_1}, \dots, p_{j_L})$:
      \begin{displaymath}
          \ell((p_{j_1}, \dots, p_{j_L})) = \sum_{k=1}^{L-1} \log \left( P(p_{j_{k+1}} | p_{j_k}) \right)
      \end{displaymath}
\end{itemize}
where $p_{j_1} = p_s$ and $p_{j_L} = p_e$.

%For trajectory $(p_{j_1}, \dots, p_{j_L})$ with respect to constraints $(p_s, p_e, L)$, 
%where $p_{j_1} = p_s$ and $p_{j_L} = p_e$, 
%define the likelihood of the trajectory
%\begin{align*}
%    & \mathcal{L} \left( (p_{j_1}, \dots, p_{j_L}) | (p_s, p_e, L) \right) \\
%  =:& \prod_{k=1}^L P_R(p_{j_k} |(p_s, p_e, L)) \times \prod_{k=1}^{L-1} P(p_{j_{k+1}} | p_{j_k})
%\end{align*}

%TODO: remove ranking probs. from definition of trajectory likelihood
%TODO: formulate the optimisation objective as a weighted sum of ranking and transition

%To recommend the \textit{most likely} trajectory with respect to constraints $(p_s, p_e, L)$,
%what we need to do is finding a trajectory of maximum likelihood with respect to constraints $(p_s, p_e, L)$,
%i.e.,

Thus, we can optimize the following objective:
\begin{displaymath}
    \gamma \ell_R((p_{j_1}, \dots, p_{j_L})) + (1 - \gamma) \ell((p_{j_1}, \dots, p_{j_L}))
\end{displaymath}
where the parameter $\gamma \in [0, 1]$ was used to trade-off the importance between the ranking probabilities 
and likelihood of the recommended trajectory.
i.e.,
\begin{align*}
    & \argmax_{(p_{j_1}, \dots, p_{j_L})} \gamma \ell_R((p_{j_1}, \dots, p_{j_L})) + (1 - \gamma) \ell((p_{j_1}, \dots, p_{j_L})) \\
%    & \argmax_{(p_{j_1}, \dots, p_{j_L})} \mathcal{L} \left( (p_{j_1}, \dots, p_{j_L}) | (p_s, p_e, L) \right) \\
%which is equivalent to
%\begin{align*}
%   =& \argmax_{(p_{j_1}, \dots, p_{j_L})} \log \left( \mathcal{L} \left( (p_{j_1}, \dots, p_{j_L}) | (p_s, p_e, L) \right) \right) \\
%   =& \argmax_{(p_{j_1}, \dots, p_{j_L})} \log \left( \prod_{k=1}^L P_R(p_{j_k} |(p_s, p_e, L)) \times 
%      \prod_{k=1}^{L-1} P(p_{j_{k+1}} | p_{j_k}) \right) \\
   =& \argmax_{(p_{j_1}, \dots, p_{j_L})} \gamma \sum_{k=1}^L \log \left( P_R(p_{j_k} |(p_s, p_e, L)) \right) + 
    (1 - \gamma) \sum_{k=1}^{L-1} \log \left( P(p_{j_{k+1}} | p_{j_k}) \right) \\
   =& \argmin_{(p_{j_1}, \dots, p_{j_L})} - \gamma \sum_{k=1}^L \log \left( P_R(p_{j_k} |(p_s, p_e, L)) \right) -
    (1 - \gamma) \sum_{k=1}^{L-1} \log \left( P(p_{j_{k+1}} | p_{j_k}) \right) 
\end{align*}
such that
\begin{align*}
    p_{j_1} &= p_s \\
    p_{j_L} &= p_e \\
    p_{j_k} &\in \mathcal{P}, 1 \le k \le L \\
    \gamma  &\in [0, 1]
\end{align*}

One way to find such a trajectory is transforming the above optimization problem to 
find a shortest path in a weighted graph.

Concretely,
we create a weighted directed graph $G$ with vertices $V$ that corresponds to the set of POIs $\mathcal{P}$ and 
edges $E$ which corresponds to transitions between POIs in $\mathcal{P}$,
the weight of vertex $v_{p}, p \in \mathcal{P}$ is set to the negative logarithm of the ranking probability of POI $p$, 
and the weight of directed edge $(v_p, v_{p'})$ is the negative logarithm of the transition probability from $p$ to $p'$,
i.e.,
\begin{align*}
    w(v_{p})       & = -\log(P_R(p | (p_s, p_e, L))) \\
    w(v_p, v_{p'}) & = -\log(P(p' | p))
\end{align*}

Thus, compute the most likely trajectory with respect to constraints $(p_s, p_e, L)$ is
equivalent to find a path (not necessarily a simple path) from vertex $v_{p_s}$ to
$v_{p_e}$ with exactly $L$ vertices and minimum total path weights,
i.e.,
\begin{displaymath}
    \argmin_{(v_1, \dots, v_L)} \gamma \sum_{i=1}^{L} w(v_i) + (1 - \gamma) \sum_{i=1}^{L-1} w(v_i, v_{i+1})
\end{displaymath}
such that
\begin{align*}
    v_1 &= v_{p_s} \\
    v_L &= v_{p_e} 
\end{align*}
    
The path can be found using dynamic programming, 
with array $A[l, v]$ stores the minimum total weights of path 
that starts at vertex $v_{p_s}$ and ends at vertex $v$ with 
exactly $l$ vertices in path,
array $B[l, v]$ stores the predecessor of $v$ in that path,
and compute a path with $l+1$ vertices by simply using the following recursive relations,
\begin{align*}
    A[l+1, v] &= \min_{v' \in Pa_v} \{ A[l, v'] + \gamma w(v) + (1-\gamma) w(v', v) \} \\
    B[l+1, v] &= \argmin_{v' \in Pa_v} \{ A[l, v'] + \gamma w(v) + (1-\gamma) w(v', v) \} 
\end{align*}
where $Pa_v$ is the parent of vertex $v$ in $G$,
i.e., 
there is a directed edge from $v'$ to $v$, $v' \in Pa_v$.

The minimum path weight is $A[L, v_{p_e}]$,
and the actual path can be found by tracing back from $B[L, v_{p_e}]$,
the complete algorithm to find this path is shown in figure \ref{fig:path},
the sequence of POIs corresponding to vertices in that path is the 
trajectory we would like to recommend with respect to constraints $(p_s, p_e, L)$.

%\begin{figure*}
\begin{figure}
\centering
\begin{tabular}{rl}
\hline
 1:&\textbf{procedure} FindPath$(V, E, p_s, p_e, L)$ \\
 2:&\hspace{10pt} \textbf{for} $v \in V$ \\
 3:&\hspace{20pt}     \textbf{if} $(v_{p_s}, v) \in E$ \\
4:&\hspace{30pt}          $A[2, v] = w(v_{p_s}, v) + \gamma w(v) + (1-\gamma) w(v_{p_s})$ \\
 5:&\hspace{30pt}         $B[2, v] = v_{p_s}$ \\
 6:&\hspace{20pt}     \textbf{else} \\
 7:&\hspace{30pt}         $A[2, v] = +\infty$ \\
 8:&\hspace{10pt} \textbf{end for} \\
 9:&\hspace{10pt} \textbf{for} $l=3$ \textbf{to} $L$ \\
10:&\hspace{20pt}     \textbf{for} $v \in V$ \\
11:&\hspace{30pt}         $A[l, v] = \min_{v' \in Pa_v} \{ A[l-1, v'] + \gamma w(v) + (1-\gamma) w(v', v) \}$ \\
12:&\hspace{30pt}         $B[l, v] = \argmin_{v' \in Pa_v} \{ A[l-1, v'] + \gamma w(v) + (1-\gamma) w(v', v) \}$ \\
13:&\hspace{20pt}     \textbf{end for} \\
14:&\hspace{10pt} \textbf{end for} \\
% //trace back to find the actual path
15:&\hspace{10pt} $path = [v_{p_e}]$ \\
16:&\hspace{10pt} $v = path[0]$ \\
17:&\hspace{10pt} $l = L$ \\
18:&\hspace{10pt} \textbf{repeat} \\
19:&\hspace{20pt}     $path$.prepend$(B[l, v])$ \\
20:&\hspace{20pt}     $v = path[0]$ \\
21:&\hspace{20pt}     $l = l - 1$ \\
22:&\hspace{10pt} \textbf{util} $l < 2$ \\
23:&\hspace{10pt} \textbf{return} $path$ \\
24:&\textbf{end procedure} \\
\hline
\end{tabular}
\caption{Path Finding}
\label{fig:path}
%\end{figure*}
\end{figure}


%\section{Acknowledgments}

\bibliographystyle{abbrv}
\bibliography{ref}

\end{document}
